% Citation for classifiers as a good group comparison tool
% Yang and Yang on LDA being performed on PC

\subsection*{Data collection}

We sampled 466 male \textit{A. sagrei} from seven islands in the Bahamas Archipelago -- Abaco, North Andros, South Andros, South Bimini, Eleuthera, Long Island, and Ragged Island -- and two in the Cayman Islands -- Cayman Brac and Little Cayman (Figure \ref{fig:maps}A). These islands were chosen to span the breadth of the West Indian range of \textit{A. sagrei}, because they have highly similar habitat types,  and because the \textit{A. sagrei} on each island group are derived from ancient and distinct colonization events from Cuba (i.e. relatively evolutionarily independent, \citealt{Reynolds2020}). Three habitats were sampled on each island based on characterizations by \citet{Howard1950} and \citet{Schoener1968}. Each habitat is clearly distinguishable by its dominant vegetation type --- xeric beach scrub (open, relatively dry habitat consisting of low vegetation or isolated trees), primary coppice forest (closed-canopy forest) and mangrove forest (wet coastal habitat with trees growing in brackish water and high light penetration). Sample sizes are given in Table \ref{tab:counts}. Our sampling design enabled us to test for differences between habitats at a coarse and fine geographical scale. The median distance between two localities within an island was $\sim 11$km (Figure \ref{fig:maps}B), and $80.3$\% of all pairwise distances within islands were less than $50$km. Additionally, there are no major barriers to dispersal (such as mountains or grassland) on any of the islands that we sampled.

\subsection*{Reflectance measurements}

We measured reflectance between 300nm and 700nm wavelength, a range from ultraviolet to red that encompasses the colors visible to most lizards and vertebrates in general \citep{Lazareva2012}. Measurements were taken with an Ocean Optics USB4000 spectrometer, a pulsed Xenon light source (PX-2, Ocean Optics, Largo, FL, USA) and a reflectance probe protected by a black anodized aluminum sheath. Measurements were taken with a 45-degree inclination to prevent specular reflection \citep{Endler1990}. The device was regularly standardized with a Spectralon white standard (Labsphere, North Sutton, NH, USA). Reflectance was measured at the center of the dewlap. Reflectance curves were smoothed using the R package pavo \citep{Maia2013} as well as with custom R functions, down to one reflectance value at each nanometer in wavelength from 300 to 700nm. 

\subsection*{Analysis}

We tested for detectable differences in dewlap coloration between populations from different habitats across islands by following an analytic pipeline in several steps. First, we used multivariate analyses of variance to assess the relative contributions of islands, habitats and habitat-by-island interactions on the partitioning of variation in color space. Second, and provided that habitat-by-island interactions were found, we investigated habitat-differences in dewlap color for each island separately using machine learning classification. Third, for each island where multivariate differences were detected using our machine learning pipeline, we used univariate analyses of variance to decompose the signal among the different dimensions of color space. Fourth, for each significant between-habitat variation found in univariate analyses, we used post-hoc tests to determine which habitats were responsible for the differences. Last, to get insights into the spatial scale of phenotypic variation, for each significant contrast between two habitats detected along a given dimension on a given island, we performed multiple pairwise Wilcoxon tests to assess differences in dewlap coloration among the sites involved in that significant contrast, and recorded the geographical distance between sites that were found significant. In parallel, we tested a possible effect of isolation-by-distance, an alternative cause of phenotypic divergence between localities, based on diffusion approximation and dispersal distance, irrespective of habitat-types. We did so using a permutation test to assess the significance of the correlation between geographical distances and phenotypic distances among sites within each island.\\

All analyses in this study were performed in R 3.6.1 \citep{RCoreTeam2019} and the source code can be found at https://github.com/rscherrer/dewlap, presently private.

\subsubsection*{Dimensionality reduction}

Because neighboring wavelengths are highly collinear and redundant in reflectance, we reduced the dimensionality of the data using principal component analysis (PCA), as per \citet{Cuthill1999} and \citet{Leal2002}. We performed PCA on data from all islands combined, as well as on each island separately and systematically retained the first four principal components (PC), which together always explained more than $88.8\%$ of the variance across islands (Table \ref{tab:pcavariances}). PCs need not represent the same wavelengths across islands because they are fitted on different datasets. Nevertheless, PC1 was highly collinear with brightness for all islands (Figure \ref{fig:brightness}), while the other PCs captured the chromatic variation (i.e. irrespective of brightness) in dewlap color.

\subsubsection*{Among-island variance partitioning}

We performed a two-way nonparametric multivariate analysis of variance (PERMANOVA, \citealt{Anderson2001}, R package vegan, \citealt{Oksanen2019}) to identify differences in coloration between islands, habitats and habitats within islands, using principal components fitted on data from all islands together. We used a nonparametric test because although no multivariate outliers were detected based on the Mahalanobis distance, the assumption of multivariate normality was violated in several habitats on several islands (Henze-Zirkler's test, \citealt{Henze1990}, R package MVN, \citealt{Korkmaz2014}, $P < 0.05$, Table \ref{tab:multinorm}).

\subsubsection*{Within-island machine learning}

We performed a machine learning classification analysis on the first four principal components within each island separately, using random forests \citep{Breiman2001}. Random forests are a versatile, intuitive, and powerful algorithm commonly used in machine learning, using decision trees to predict the labels of particular observations based on their multivariate coordinates. These coordinates, or variables, are passed through a series of successive decision nodes, each examining a given variable of any given observation \citep{James2013}. The prediction for each observation is an aggregate over a large number of decision trees, each tree being trained on a subset of observations sampled with replacement from the dataset, and each tree being allowed to examine only a subset of the variables. This allows the random forest to overcome the individual errors of all trees in the predictions it makes.\\

To detect differences in dewlap coloration between habitats, we measured the success of random forests in reassigning individual lizards to their correct habitat of origin, based solely on their principal component scores. In machine learning, this so-called cross-validation procedure is typically done in two steps \citep{James2013}. First, a random forest is trained in recognizing features of dewlap coloration most associated with the different habitats, by being presented with multiple observations, making predictions about them, and updating its own decision rules based on whether the prediction deviates from the truth. Then, once trained, the patterns that the random forest has learned to recognize are tested by presenting new, previously unseen observations to the random forest, and measuring the proportion of correct predictions. This proportion, or success score, can then be statistically assessed against random guessing using a binomial test.\\

The cross-validation procedure requires that the data be split into a training set and a testing set. To remove any bias due to the set that is being sampled for training, it is common practice to use k-fold cross-validation \citep{James2013}, where the data are split into $k$ random bins and $k$ independent machines are trained, each taking one of the bins as a testing set and the rest for training, and where classification success is measured by summing all correct classifications from the $k$ machines.\\

Here, we used a k-fold cross-validation procedure with $k = 5$, where each training set consisted of 80\% of the data and the machine was tested on the remaining 20\%. Each training set was conditioned on containing at least five lizards from each of the three habitats. We also down-sampled the training set to the sample size of the least represented habitat, to ensure that the different habitats were equally represented. To further remove any bias due to the specific random split into the different bins, we replicated each k-fold cross-validation five times. We then averaged the five resulting confusion matrices across replicates, where each confusion matrix shows the number of lizards from each habitat reassigned into each habitat. For each island, we then used the average proportion of correctly reassigned lizards (i.e. the proportion of observations on the diagonal of the average confusion matrix) as an estimate of classification success. This score was tested against random guessing by comparing it to a binomial distribution with number of trials being the number of lizards on that island and success probability $1/3$, representing the rate of successful classification by chance when three habitats are involved.\\

We used the machine learning fitting functions in the R package rminer \citep{Cortez2020}, which calls random forest routines from the randomForest package (\citealt{Liaw2002}, implementation from the original random forest algorithm \citealp{Breiman2001}). For each random forest, we optimized the number of trees in the forest and the number of variables examined by each tree using the grid hyperparameter search procedure implemented in rminer, to choose between two numbers of trees (500 or 1,000) and four numbers of principal components examined per tree (1 to 4), using rminer's ordered holdout validation method with $2/3$ of the data used for training.\\

We validated the results of our analysis by using two other widely used machine learning classification methods: linear discriminant analysis and support vector machines \citep{Cristianini2000, James2013}, both accessible in rminer \citep{Cortez2020}.\\

To know which wavelengths were most used to assign data points to each habitat, we trained another set of random forests, this time directly on reflectance data (taken every 5nm from 300 to 700nm) instead of principal components. We recorded the relative importance of each wavelength for each habitat, as measured by the mean decrease in accuracy during wavelength permutation, implemented in the randomForest package \citep{Liaw2002}.

\subsubsection*{Univariate analyses}

For each island where significant differences in dewlap coloration were detected between habitats, we used multiple univariate analyses of variance (ANOVA) to identify possible principal components underlying the observed differences. We constructed our ANOVA models in two steps, as per \citet{Zuur2009}. In a first step, we accounted for heterogeneity of variances across groups by systematically comparing the goodness-of-fit of an ANOVA model estimated with ordinary least squares (OLS) with that of a model estimated with generalized least squares (GLS), which allowed one estimate of residual variance per habitat (using the R package nlme, \citealt{Pinheiro2000, Pinheiro2020}). Both models were fitted with restricted maximum likelihood (REML). Goodness-of-fit was estimated using Akaike's Information Criterion corrected for small sample sizes (AICc, R package MuMIn, \citealt{Barton2019}), and the estimation method yielding the lowest AICc was retained. In a second step, we re-fitted the retained model with maximum likelihood (ML) to test for the effect of habitat-type using likelihood ratio tests (LRT) between a model including a habitat-term and a null model lacking the habitat-term.\\

We evaluated the normality of the standardized residuals (residuals divided by their standard error, which can differ among habitats in a GLS model) of each fitted ANOVA model using Shapiro-Wilk's test, with P-values adjusted for multiple testing using the Benjamini-Hochberg correction \citep{Benjamini1995}. In cases where significant deviations from normality were detected ($P_{adj} < 0.05$, Table \ref{tab:normality}) we performed Kruskal-Wallis's nonparametric test to back up the ANOVA results.\\

To know which habitat-populations were different from which in dewlap coloration, we performed different post-hoc multiple comparison tests (all implemented in the PMCMRplus package, \citealp{Pohlert2020}), depending on which assumptions were met. In cases where normality and homoscedasticity were met (i.e. OLS-ANOVA was the best fit), we used Tukey's honest significant difference test. When normality was met but not homoscedasticity (i.e. GLS-ANOVA was the best fit), we used Dunnett's T3 test. Finally, whenever we used Kruskal-Wallis's test because the ANOVA residuals were not normally distributed, we used Nemenyi's test for post-hoc comparisons.

\subsubsection*{Spatial autocorrelation}

We tested for within-island spatial autocorrelation between the geographical distances among sampling sites and their Euclidean distances in multivariate color space (mean PC1 to PC4 per site, Table \ref{tab:sites}), regardless of habitat-type. Because often only a few sites were sampled per island, we could not get meaningful results from tests that use sites as units of observation, such as Moran's I test \citep{Gittleman1990}. Instead, we designed a permutation test where we randomly reshuffled individual lizards across sites within islands 1,000 times each, and systematically recalculated Pearson's correlation coefficient between geographic distances (computed as geodesic distances in the R package geosphere; \citealt{Hijmans2019}) and phenotypic distances. We used the resulting null distributions of correlation coefficients to assess the significance of the observed spatial autocorrelation for each island.

\subsubsection*{Site differences}

In this study, we were interested in the minimum spatial scale at which significant differences between habitats could be detected within islands. We performed multiple pairwise nonparametric Wilcoxon-Mann-Whitney tests \citep{Hollander2013} to compare dewlap coloration between sites with different habitat-types, for each pair of habitats and each variable where significant differences were detected with our analyses of variance. The P-values were adjusted using a Benjamini-Hochberg correction for multiple testing \citep{Benjamini1995}.